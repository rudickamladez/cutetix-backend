services:
  api:
    image: ghcr.io/rudickamladez/cutetix-backend:master
    # build:
    #  context: .
    #  dockerfile: ./Dockerfile
    #  args:
    #    - http_proxy
    #    - https_proxy
    #    - no_proxy
    restart: always
    # depends_on:
    #   - mariadb
    ports:
      - "8001:80"
    volumes:
      - type: bind
        source: ./db
        target: /var/www/db
        bind:
          create_host_path: false
    environment:
      SQLALCHEMY_DATABASE_URL: "sqlite:///./db/sql_lite.db"
      # SQLALCHEMY_DATABASE_URL: "mariadb+mariadbconnector://${MARIADB_USER}:${MARIADB_PASSWORD}@mariadb/${MARIADB_DATABASE}"
      # SQLALCHEMY_DATABASE_URL: "mariadb+mariadbconnector://root:${MARIADB_PASSWORD}@mariadb/${MARIADB_DATABASE}"
      TZ: Europe/Prague
      JWT_SECRET_LOCATION: /run/secrets/jwt_secret
      JWT_PUBLIC_LOCATION: /run/secrets/jwt_public
      MCP_PUBLIC_BASE_URL: "https://api-dev.cutetix.com"
      MCP_OAUTH_ENABLED: "true"
      MCP_OAUTH_INTERNAL: "true"
      MCP_OAUTH_ISSUER: "https://api-dev.cutetix.com"
      MCP_OAUTH_AUTHORIZATION_ENDPOINT: "https://api-dev.cutetix.com/oauth/authorize"
      MCP_OAUTH_TOKEN_ENDPOINT: "https://api-dev.cutetix.com/oauth/token"
      MCP_OAUTH_REGISTRATION_ENDPOINT: "https://api-dev.cutetix.com/oauth/register"
      MCP_OAUTH_CLIENT_ID: "CHANGEME"
      MCP_OAUTH_CLIENT_SECRET: "CHANGEME"
      MCP_OAUTH_SCOPES_SUPPORTED: '["openid","profile","email","users:read","users:edit","events:read","events:edit","token_family:read","ticket_groups:read","ticket_groups:edit","tickets:read","tickets:edit"]'
      MCP_OAUTH_TOKEN_ENDPOINT_AUTH_METHODS_SUPPORTED: '["none"]'
      MCP_OAUTH_CODE_CHALLENGE_METHODS_SUPPORTED: '["S256"]'
      MCP_OAUTH_RESOURCE_DOCUMENTATION: "https://api-dev.cutetix.com/docs"
      MCP_OAUTH_RESOURCE_METADATA_PATH: "/.well-known/oauth-protected-resource"
      MCP_OAUTH_JWKS_URL: "https://api-dev.cutetix.com/.well-known/jwks.json"
      MCP_OAUTH_AUDIENCE: "https://api-dev.cutetix.com"
      MCP_OAUTH_JWT_ALGORITHMS: '["RS256"]'
      MCP_OAUTH_USERNAME_CLAIMS: '["preferred_username","email","sub"]'
      MCP_OAUTH_REDIRECT_URIS: '["https://chatgpt.com/connector_platform_oauth_redirect","https://platform.openai.com/apps-manage/oauth"]'
      MCP_OAUTH_FRONTEND_LOGIN_URL: ""
    secrets:
      - jwt_secret
      - jwt_public
    stdin_open: true
    tty: true
    depends_on:
      migrate:
        condition: service_completed_successfully

  migrate:
    image: ghcr.io/rudickamladez/cutetix-backend:master
    entrypoint: ["alembic"]
    command: ["upgrade", "head"]
    environment:
      DB_URL: "sqlite:///./db/sql_lite.db"
    volumes:
      - type: bind
        source: ./db
        target: /var/www/db
        bind:
          create_host_path: false
    # spouštěj ručně: `docker compose run --rm migrate upgrade head`
    # (jako "job" – bez restartu, bez publikovaných portů)

  # mariadb:
  #   # image: mariadb:${MARIADB_VERSION}
  #   build:
  #     context: ./our_mariadb
  #     args:
  #       VERSION: ${MARIADB_VERSION:-latest}
  #       USER_ID: ${USER_ID:-0}
  #       GROUP_ID: ${GROUP_ID:-0}
  #   restart: always
  #   command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${MARIADB_PASSWORD}
  #     MYSQL_DATABASE: ${MARIADB_DATABASE}
  #     MYSQL_USER: ${MARIADB_USER}
  #     MYSQL_PASSWORD: ${MARIADB_PASSWORD}
  #     # Copy-pasted from https://community.home-assistant.io/t/mariadb-errors-after-update/424731/4
  #     MARIADB_AUTO_UPGRADE: 1
  #     # MARIADB_INITDB_SKIP_TZINFO: 1
  #     TZ: Europe/Prague
  #   volumes:
  #     - ./mysql:/var/lib/mysql
  #   healthcheck:
  #     # Copy-pasted from https://mariadb.com/kb/en/using-healthcheck-sh/
  #     interval: 30s
  #     retries: 3
  #     test: ["CMD", "/usr/local/bin/healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized"]

secrets:
  jwt_secret:
    file: ./private.pem
  jwt_public:
    file: ./public.pem
